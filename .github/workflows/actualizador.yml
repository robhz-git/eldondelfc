name: Actualizador Definitivo
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Python Setup
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Deps
        run: pip install requests beautifulsoup4
      - name: Update
        run: |
          python << END
          import requests
          from bs4 import BeautifulSoup
          import re

          h = {'User-Agent': 'Mozilla/5.0'}

          # CÓDIGO FC MOBILE
          def get_code():
              try:
                  r = requests.get("https://www.fcmobileforum.com/fcmobile-redeem-codes", headers=h, timeout=20)
                  s = BeautifulSoup(r.text, 'html.parser')
                  for tr in s.find_all('tr'):
                      tds = tr.find_all('td')
                      if len(tds) >= 2 and "active" in tds[1].text.lower():
                          code = tds[0].text.strip()
                          if code.isupper() and " " not in code: return code
                  return "REVISA TIKTOK"
              except: return "REVISA TIKTOK"

          # NOTICIAS
          def get_news(q):
              url = f"https://news.google.com/rss/search?q={q}&hl=es-419&gl=MX&ceid=MX:es-419"
              try:
                  r = requests.get(url, timeout=20)
                  s = BeautifulSoup(r.content, "xml")
                  html = ""
                  for i in s.find_all('item')[:3]:
                      title = i.title.text.rsplit(" - ", 1)[0]
                      html += f'<div class="news-item"><h4>{title}</h4><a href=\"{i.link.text}\" target=\"_blank\">Leer más</a></div>'
                  return html if html else "<h4>Buscando...</h4>"
              except: return "<h4>Error de carga</h4>"

          code = get_code()
          n_mundial = get_news("FIFA World Cup 2026")
          n_champ = get_news("Champions League ESPN")

          with open('index.html', 'r', encoding='utf-8') as f:
              c = f.read()

          # Inyectar con Regex simplificado (buscamos el ID exacto)
          c = re.sub(r'<div id="daily-code" class="code-box">.*?</div>', f'<div id="daily-code" class="code-box">{code}</div>', c)
          c = re.sub(r'<div id="mundial-news">.*?</div>', f'<div id="mundial-news">{n_mundial}</div>', c, flags=re.DOTALL)
          c = re.sub(r'<div id="champions-news" style="display:none;">.*?</div>', f'<div id="champions-news" style="display:none;">{n_champ}</div>', c, flags=re.DOTALL)

          with open('index.html', 'w', encoding='utf-8') as f:
              f.write(c)
          END
      - name: Push
        run: |
          git config --global user.name 'Bot'
          git config --global user.email 'bot@bot.com'
          git add index.html
          git commit -m "Update" || exit 0
          git push
