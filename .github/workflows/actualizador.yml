name: Actualizador ElDonDelFC
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Deps
        run: pip install requests beautifulsoup4
      - name: Run Bot
        run: |
          python << END
          import requests
          from bs4 import BeautifulSoup
          import re

          # EngaÃ±amos a la web para que crea que somos un navegador real
          h = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36'}

          def get_fc_code():
              try:
                  r = requests.get("https://www.fcmobileforum.com/fcmobile-redeem-codes", headers=h, timeout=20)
                  s = BeautifulSoup(r.text, 'html.parser')
                  # Buscamos en la tabla de cÃ³digos activos
                  for row in s.find_all('tr'):
                      cells = row.find_all('td')
                      if len(cells) >= 2 and "active" in cells[1].text.lower():
                          code = cells[0].get_text().strip()
                          if code.isupper() and len(code) > 4:
                              return code
                  return "REVISA EL LINK"
              except:
                  return "REVISA EL LINK"

          new_code = get_fc_code()

          with open('index.html', 'r', encoding='utf-8') as f:
              content = f.read()

          # Inyectamos el cÃ³digo en el div con ID daily-code
          content = re.sub(r'<div id="daily-code" class="code-display">.*?</div>', 
                           f'<div id="daily-code" class="code-display">{new_code}</div>', content)

          with open('index.html', 'w', encoding='utf-8') as f:
              f.write(content)
          END
      - name: Deploy
        run: |
          git config --global user.name 'ElDonBot'
          git config --global user.email 'bot@eldondelfc.io'
          git add index.html
          git commit -m "ðŸ¤– Bot: CÃ³digo actualizado satisfactoriamente" || exit 0
          git push
